<script>
let currentStep = 1;
let selectedPurpose = '';
let targetAmount = '';
let currentSavings = '';

function nextStep() {
    console.log('nextStep called, current step:', currentStep);
    if (currentStep < 7) {
        document.getElementById('step' + currentStep).classList.remove('active');
        currentStep++;
        document.getElementById('step' + currentStep).classList.add('active');
        console.log('moved to step:', currentStep);
    }
}

function prevStep() {
    console.log('prevStep called, current step:', currentStep);
    if (currentStep > 1) {
        document.getElementById('step' + currentStep).classList.remove('active');
        currentStep--;
        document.getElementById('step' + currentStep).classList.add('active');
        console.log('moved to step:', currentStep);
    }
}

function selectPurpose(element, purpose) {
    console.log('selectPurpose called:', purpose);
    document.querySelectorAll('.option-button').forEach(btn => {
        btn.classList.remove('selected');
    });
    element.classList.add('selected');
    selectedPurpose = purpose;
    document.getElementById('purpose-error').style.display = 'none';
    setTimeout(() => {
        nextStep();
    }, 500);
}

function validateAndNext(type) {
    console.log('validateAndNext called:', type);
    let isValid = false;
    
    if (type === 'purpose') {
        if (selectedPurpose) {
            isValid = true;
            document.getElementById('purpose-error').style.display = 'none';
        } else {
            document.getElementById('purpose-error').style.display = 'block';
        }
    } else if (type === 'amount') {
        const amount = document.getElementById('target-amount').value.trim();
        if (amount) {
            targetAmount = amount;
            isValid = true;
            document.getElementById('amount-error').style.display = 'none';
        } else {
            document.getElementById('amount-error').style.display = 'block';
        }
    } else if (type === 'savings') {
        const savings = document.getElementById('current-savings').value.trim();
        if (savings) {
            currentSavings = savings;
            isValid = true;
            document.getElementById('savings-error').style.display = 'none';
        } else {
            document.getElementById('savings-error').style.display = 'block';
        }
    }
    
    if (isValid) {
        nextStep();
    }
}

function showProgress() {
    console.log('showProgress called');
    nextStep();
    let progress = 0;
    const progressElement = document.querySelector('.percentage');
    const interval = setInterval(() => {
        progress += 2;
        progressElement.textContent = progress + '%';
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                nextStep();
            }, 500);
        }
    }, 60);
}

function updateAsset(value) {
    const assetValue = parseInt(value);
    document.getElementById('current-asset').textContent = assetValue.toLocaleString() + '만원';
}

function updateIncome(value) {
    const incomeValue = parseInt(value);
    document.getElementById('monthly-income').textContent = incomeValue.toLocaleString() + '만원';
}

function updateExpense(value) {
    const expenseValue = parseInt(value);
    document.getElementById('monthly-expense').textContent = expenseValue.toLocaleString() + '만원';
}

function recalculate() {
    console.log('recalculate called');
    const btn = document.querySelector('.recalculate-btn');
    btn.disabled = true;
    btn.textContent = '계산 중...';
    
    setTimeout(() => {
        const currentAsset = parseInt(document.getElementById('asset-slider').value);
        const monthlyIncome = parseInt(document.getElementById('income-slider').value);
        const monthlyExpense = parseInt(document.getElementById('expense-slider').value);
        
        const monthlySavings = monthlyIncome - monthlyExpense;
        const baseAsset = 5000;
        const baseIncome = 317;
        const baseExpense = 208;
        const baseSavings = baseIncome - baseExpense;
        
        const assetRatio = currentAsset / baseAsset;
        const savingsRatio = monthlySavings / baseSavings;
        
        let totalMonths = 42;
        
        if (savingsRatio > 0) {
            totalMonths = Math.max(12, Math.round(42 / (savingsRatio * 1.2)));
            totalMonths = Math.max(12, Math.round(totalMonths / (assetRatio * 0.3 + 0.7)));
        } else {
            totalMonths = 60;
        }
        
        const years = Math.floor(totalMonths / 12);
        const months = totalMonths % 12;
        const days = Math.floor(Math.random() * 28) + 1;
        
        const targetDate = new Date(2024, totalMonths, days);
        const targetYear = targetDate.getFullYear();
        const targetMonth = targetDate.getMonth() + 1;
        
        const resultTitle = document.querySelector('.result-title');
        const resultDate = document.querySelector('.result-date');
        
        resultTitle.innerHTML = `약 ${years}년 ${months}개월 ${days}일 후에<br>1억을 모으실 수 있어요!`;
        resultDate.textContent = `${targetYear}년 ${targetMonth}월 ${days}일 예상`;
        
        const yearlyData = [];
        for (let i = 0; i < Math.min(5, Math.ceil(totalMonths / 12) + 1); i++) {
            const yearAsset = currentAsset + (monthlySavings * 12 * (i + 1)) * (assetRatio * 0.1 + 0.9);
            yearlyData.push(Math.round(yearAsset));
        }
        
        const years_to_show = Math.min(5, yearlyData.length);
        for (let i = 0; i < 5; i++) {
            const yearRow = document.getElementById(`year-${2024 + i}`);
            if (i < years_to_show && yearlyData[i] > 0) {
                yearRow.style.display = 'flex';
                const value = yearlyData[i] >= 10000 ? 
                    `${Math.floor(yearlyData[i] / 10000)}억 ${(yearlyData[i] % 10000).toLocaleString()}만원` :
                    `${yearlyData[i].toLocaleString()}만원`;
                yearRow.querySelector('.data-value').textContent = value;
            } else {
                yearRow.style.display = 'none';
            }
        }
        
        btn.disabled = false;
        btn.textContent = '다시 계산하기';
        
        document.querySelector('.result-summary').scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    }, 1000);
}

function resetToDefault() {
    console.log('resetToDefault called');
    document.getElementById('asset-slider').value = 5000;
    document.getElementById('income-slider').value = 317;
    document.getElementById('expense-slider').value = 208;
    
    document.getElementById('current-asset').textContent = '5,000만원';
    document.getElementById('monthly-income').textContent = '317만원';
    document.getElementById('monthly-expense').textContent = '208만원';
    
    document.querySelector('.result-title').innerHTML = '3년 6개월 20일 후에<br>1억을 모우실 수 있어요!';
    document.querySelector('.result-date').textContent = '2028년 6월 20일 예상';
    
    document.getElementById('year-2024').querySelector('.data-value').textContent = '5,100만원';
    document.getElementById('year-2025').querySelector('.data-value').textContent = '6,200만원';
    document.getElementById('year-2026').querySelector('.data-value').textContent = '7,500만원';
    document.getElementById('year-2027').querySelector('.data-value').textContent = '9,200만원';
    document.getElementById('year-2028').querySelector('.data-value').textContent = '1억 1,100만원';
    
    for (let i = 0; i < 5; i++) {
        document.getElementById(`year-${2024 + i}`).style.display = 'flex';
    }
    
    document.querySelector('.result-summary').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
    });
}

function restart() {
    console.log('restart called');
    currentStep = 1;
    selectedPurpose = '';
    targetAmount = '';
    currentSavings = '';
    
    document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
    });
    document.getElementById('step1').classList.add('active');
    
    document.querySelectorAll('.option-button').forEach(btn => {
        btn.classList.remove('selected');
    });
    document.getElementById('target-amount').value = '';
    document.getElementById('current-savings').value = '';
    
    document.querySelectorAll('.error-message').forEach(msg => {
        msg.style.display = 'none';
    });
    
    resetToDefault();
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing...');
    if (!document.getElementById('step1').classList.contains('active')) {
        document.getElementById('step1').classList.add('active');
    }
    
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('option-button') || e.target.classList.contains('main-button')) {
            e.target.style.transform = 'scale(0.95)';
            setTimeout(() => {
                e.target.style.transform = '';
            }, 150);
        }
    });
});
</script>
